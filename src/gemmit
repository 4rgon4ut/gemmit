#!/bin/bash

# A wrapper for git commit to use gemmit.

# Usage:
# gemmit [-a|--add] <template> [-y]
# gemmit [-h|--help]

if [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
    echo "Usage: gemmit [-a|--add] <template> [-y]"
    echo "       gemmit [-h|--help]"
    echo ""
    echo "Options:"
    echo "  -a, --add    Stage all tracked files before committing."
    echo "  -h, --help   Show this help message."
    echo "  -y           Automatically use the generated commit message without confirmation."
    exit 0
fi

ADD=false
if [ "$1" == "-a" ] || [ "$1" == "--add" ]; then
    ADD=true
    shift
fi

if [ -z "$1" ]; then
    echo "Usage: gemmit [-a|--add] <template> [-y]"
    exit 1
fi

TEMPLATE=$1
shift
ARGS=$@

if $ADD; then
    echo "Adding all files..."
    git add .
fi

COMMIT_MSG=$(~/.gemmit/gemmit.py $TEMPLATE)

if [ -z "$COMMIT_MSG" ]; then
    echo "Commit message generation failed. Aborting."
    exit 1
fi

if [ "$1" != "-y" ]; then
    echo "--- Generated Commit Message ---"
    echo "$COMMIT_MSG"
    echo "--------------------------------"
    read -p "Use this commit message? [Y/n] " answer
    if [[ "$answer" =~ ^[nN]$ ]]; then
        echo "Commit aborted by user."
        exit 1
    fi
fi

git commit -m "$COMMIT_MSG"
