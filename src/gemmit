#!/bin/bash

# A wrapper for git commit to use gemmit.

# Usage:
# gemmit [-a|--add] [-p|--push] [-y] <template>
# gemmit [-h|--help]

ADD=false
PUSH=false
CONFIRM=true
TEMPLATE=""

while [[ "$#" -gt 0 ]]; do
    case $1 in
        -a|--add) ADD=true; shift ;;
        -p|--push) PUSH=true; shift ;;
        -y) CONFIRM=false; shift ;;
        -h|--help)
            echo "Usage: gemmit [-a|--add] [-p|--push] [-y] <template>"
            echo "       gemmit [-h|--help]"
            echo ""
            echo "Options:"
            echo "  -a, --add    Stage all tracked files before committing."
            echo "  -p, --push   Push changes to the remote repository after committing."
            echo "  -h, --help   Show this help message."
            echo "  -y           Automatically use the generated commit message without confirmation."
            exit 0
            ;;
        *)
            if [ -z "$TEMPLATE" ]; then
                TEMPLATE=$1
                shift
            else
                echo "Unknown option: $1"
                exit 1
            fi
            ;;
    esac
done

if [ -z "$TEMPLATE" ]; then
    echo "Usage: gemmit [-a|--add] [-p|--push] [-y] <template>"
    exit 1
fi

if $ADD; then
    echo "Adding all files..."
    git add .
fi

COMMIT_MSG=$(~/.gemmit/gemmit.py $TEMPLATE)

if [ -z "$COMMIT_MSG" ]; then
    echo "Commit message generation failed. Aborting."
    exit 1
fi

# Read config
if [ -f "$HOME/.gemmit/config.json" ]; then
    CONFIG_JSON=$(cat "$HOME/.gemmit/config.json")
    AUTOCONFIRM=$(echo "$CONFIG_JSON" | python3 -c "import sys, json; print(json.load(sys.stdin).get('autoconfirm', False))")
    HIGHLIGHT_COLOR=$(echo "$CONFIG_JSON" | python3 -c "import sys, json; print(json.load(sys.stdin).get('highlight_color'))")
else
    AUTOCONFIRM=false
    HIGHLIGHT_COLOR=""
fi

# Set color codes
NC='\033[0m' # No Color
if [[ $HIGHLIGHT_COLOR =~ ^#[0-9a-fA-F]{6}$ ]]; then
    R=$(printf "%d" "0x${HIGHLIGHT_COLOR:1:2}")
    G=$(printf "%d" "0x${HIGHLIGHT_COLOR:3:2}")
    B=$(printf "%d" "0x${HIGHLIGHT_COLOR:5:2}")
    COLOR="\033[38;2;${R};${G};${B}m"
else
    COLOR=""
    NC=""
fi

if $CONFIRM && [ "$AUTOCONFIRM" != "True" ]; then
    echo "--- Generated Commit Message ---"
    echo -e "${COLOR}${COMMIT_MSG}${NC}"
    echo "--------------------------------"
    read -p "Use this commit message? [Y/n] " answer
    if [[ "$answer" =~ ^[nN]$ ]]; then
        echo "Commit aborted by user."
        exit 1
    fi
fi

git commit -m "$COMMIT_MSG"

if $PUSH; then
    REMOTE=$(git remote)
    echo -e "${COLOR}Pushing changes to $REMOTE${NC}"
    git push
fi
